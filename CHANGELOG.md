# Changelog

Все значимые изменения в этом проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Добавлено
- Система автоматических рекомендаций по оптимизации запросов
- API для анализа SQL запросов с возвратом рекомендаций
- Интеграция рекомендаций в детальные страницы запросов
- Массовый анализ запросов через management commands
- Чеклист лучших практик ClickHouse

### Автоматический анализ запросов
- **Паттерны проблем** - обнаружение common anti-patterns через regex
- **Приоритизация рекомендаций** - critical, high, medium приоритеты
- **Генерация шаблонов** - автоматические шаблоны оптимизированных запросов
- **Категории проблем** - полносканирование, отсутствие индексов, CROSS JOIN и др.

### API для анализа
- **REST API endpoint** - `/lab/api/analyze-query/`
- **JSON форма**т ввода/вывода
- **Тестовая страница** - веб-интерфейс для тестирования API
- **Поддержка CORS** - возможность интеграции с внешними системами

### Улучшения UX
- **Визуальные индикаторы** - цветовая кодировка приоритетов проблем
- **Быстрое копирование** - копирование запросов в буфер обмена
- **Уведомления** - система всплывающих уведомлений о действиях
- **Авто-расширение форм** - динамическое изменение размера textarea

## [0.5.0] - 2025-10-17

### Добавлено
- Полная система аналитики и отчетности
- Дашборды с визуализацией ключевых метрик
- Фильтруемые отчеты с детальной статистикой
- Экспорт данных в формате CSV
- Анализ трендов производительности за периоды

### Компоненты аналитики
- Ключевые метрики эффективности лаборатории
- Распределение по категориям проблем
- Топ успешных оптимизаций
- Эффективность аналитиков
- Ежедневные и еженедельные тренды

## [0.4.0] - 2025-10-15

### Добавлено
- Полнофункциональная лаборатория запросов с интерфейсом анализа
- Система тегов и категоризации проблем запросов
- Формы для анализа, оптимизации и записи результатов
- Панель быстрых действий для управления статусами запросов
- Визуальный индикатор прогресса анализа
- Подсветка SQL синтаксиса в запросах
- Функционал копирования запросов в буфер обмена
- Система уведомлений и улучшенный UX

### Лаборатория запросов
- **Дашборд лаборатории** - обзор статистики и последних запросов
- **Список запросов** - фильтрация по статусам, категориям и назначению
- **Детальные страницы** - полная информация о каждом запросе
- **Система статусов** - workflow от обнаружения до оптимизации
- **Категории проблем** - классификация типов оптимизаций

### Формы и взаимодействие
- **Форма анализа** - определение категории проблемы и тегов
- **Форма оптимизации** - предложение улучшенных версий запросов
- **Форма результатов** - запись метрик до/после оптимизации
- **Быстрые действия** - одномоментная смена статусов
- **Авто-расширение** textarea при вводе текста

### UX улучшения
- **Подсветка SQL** - визуальное выделение ключевых слов
- **Копирование запросов** - быстрый перенос в буфер обмена
- **Визуальный прогресс** - индикатор движения по workflow
- **Временная шкала** - отслеживание этапов анализа
- **Уведомления** - обратная связь о действиях пользователя

## [0.3.0] - 2025-10-15

### Добавлено
- Management commands для сбора метрик
- Автоматическое создание записей в лаборатории
- Обработка часовых поясов и дубликатов запросов
- Система отчетности и диагностики сбора данных

### Команды управления
- `collect_metrics` - основной сборщик метрик с параметризацией
- `test_connection` - проверка подключения к ClickHouse
- `purge_data` - очистка устаревших данных
- `show_stats` - статистика собранных данных
- `debug_queries` - диагностика системных запросов
- `check_activity` - анализ активности ClickHouse

### Исправлено
- Проблема с лимитом в 100 запросов (теперь настраиваемый лимит)
- Ошибки часовых поясов при сохранении datetime
- Обработка дубликатов query_id в системе сбора
- Совместимость с различными версиями ClickHouse

## [0.2.0] - 2025-10-15

### Добавлено
- Модуль `clickhouse_client` для работы с ClickHouse
- Поддержка нативного TCP протокола (порт 9000)
- Системные запросы для сбора метрик производительности
- Автоматическое обнаружение медленных запросов (>1000ms)
- Фильтрация и параметризация системных запросов

### Модуль clickhouse_client
- `ClickHouseClient` - основной клиент с retry-логикой и error handling
- `ClickHouseConfig` - конфигурация подключения к удаленным инстансам
- `SystemQueries` - набор оптимизированных запросов к system.tables
- Health check функции для проверки доступности

### Системные запросы
- Медленные запросы из `system.query_log` с фильтрацией по порогу
- Текущие выполняемые запросы из `system.processes` 
- Системные метрики и события для контекста
- Статистика производительности за период
- Информация о таблицах и базах данных

### Исправлено
- Проблема с SSL/TLS подключением для порта 9000
- Совместимость с ClickHouse 25.8.4.13 (структура system.processes)
- Обработка ошибок и таймаутов подключения

## [0.1.0] - 2025-10-13

### Добавлено
- Базовая структура Django проекта с двумя приложениями: `monitor` и `query_lab`
- Модели данных для хранения метрик ClickHouse и анализа запросов
- Админ-интерфейс для управления инстансами ClickHouse и просмотра логов
- Маршрутизация с редиректом с корневого URL на дашборд мониторинга
- Базовые шаблоны для дашбордов мониторинга и лаборатории запросов
- Конфигурация подключения к ClickHouse через environment variables

### Модели данных
- `ClickHouseInstance` - настройки подключения к инстансам ClickHouse
- `QueryLog` - сырые данные запросов из system.query_log
- `SlowQuery` - медленные запросы для анализа в лаборатории

### Технические детали
- Стек: Django 4.2+, Python 3.8+, SQLite
- Структура: два основных приложения (monitor, query_lab)
- Шаблоны: кастомные директории для каждого приложения
- Конфигурация: выделенная система настроек ClickHouse

---

## Статус разработки

### ✅ Завершено
- **Этап 1**: Базовая инфраструктура Django
- **Этап 2**: Сбор данных из ClickHouse
- **Этап 3**: Лаборатория запросов  
- **Этап 4**: Аналитика и отчеты
- **Этап 5.1**: Автоматические рекомендации и API

### 🚧 В процессе
- **Этап 5.2**: Интеграция с EXPLAIN PLAN/PIPELINE

### 📋 Планируется
- Хранение результатов анализа в базе данных
- Расширенный анализ с историческими данными
- Система рекомендаций по индексам
- Интеграция с реальными метриками выполнения

## Результаты работы системы

### Текущее состояние
- **Полностью рабочая система** мониторинга и оптимизации ClickHouse
- **Автоматический сбор** медленных запросов каждые 5 минут
- **Лаборатория** для анализа и предложения оптимизаций
- **Система отчетности** с аналитикой эффективности
- **API для анализа** произвольных SQL запросов
- **52 запроса** готовы для анализа в лаборатории

### Функциональность системы
- ✅ **Мониторинг** - автоматическое обнаружение проблемных запросов
- ✅ **Анализ** - инструменты для диагностики и категоризации
- ✅ **Оптимизация** - предложение и тестирование улучшений
- ✅ **Отслеживание** - система статусов и workflow
- ✅ **Аналитика** - метрики эффективности и отчетность
- ✅ **Экспорт** - интеграция с внешними инструментами
- ✅ **API** - программный интерфейс для анализа
- ✅ **Рекомендации** - автоматические предложения по оптимизации

### Технические достижения
- **Автоматический анализ** - обнаружение 10+ паттернов проблем
- **Приоритизация** - классификация проблем по critical/high/medium
- **REST API** - JSON API для интеграций
- **Визуализация** - интерактивные дашборды и отчеты
- **Масштабируемость** - модульная архитектура для расширения

---

## О проекте

**ClickHouse Monitoring & Query Optimization System** - система мониторинга производительности ClickHouse с встроенной лабораторией для анализа и оптимизации запросов.

### Назначение
- Мониторинг производительности ClickHouse в реальном времени
- Выявление медленных и проблемных запросов
- Анализ и оптимизация запросов в специальной "лаборатории"
- Накопление знаний о лучших практиках работы с ClickHouse

### Критерии успеха Этапа 5.1
- ✅ Система автоматических рекомендаций по оптимизации
- ✅ API для программного анализа запросов
- ✅ Интеграция рекомендаций в интерфейс лаборатории
- ✅ Поддержка массового анализа через management commands
- ✅ Чеклист лучших практик ClickHouse

### Следующие шаги
**Этап 5.2: Интеграция с EXPLAIN PLAN/PIPELINE** - добавление анализа реальных планов выполнения запросов, интеграция с system.query_log для исторического анализа, создание системы хранения результатов анализа.