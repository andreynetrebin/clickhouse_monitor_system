{% extends 'query_lab/base.html' %}
{% load humanize %}

{% block title %}–û—Ç—á–µ—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
<div class="card">
    <h1>üìã –û—Ç—á–µ—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º</h1>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <form method="get" style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–î–∞—Ç–∞ —Å:</label>
                <input type="date" name="start_date" value="{{ filters.start_date }}" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–î–∞—Ç–∞ –ø–æ:</label>
                <input type="date" name="end_date" value="{{ filters.end_date }}"
                       style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <select name="category" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px;">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for value, label in category_choices %}
                    <option value="{{ value }}" {% if filters.category == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–°—Ç–∞—Ç—É—Å:</label>
                <select name="status" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px;">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button type="submit" class="btn">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <a href="{% url 'optimization_report' %}" class="btn" style="background: #95a5a6;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</a>
            <a href="{% url 'export_optimizations_csv' %}?{{ request.GET.urlencode }}" class="btn" style="background: #27ae60;">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
        </div>
    </form>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.optimized }}</div>
            <div class="stat-label">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.avg_improvement|floatformat:1 }}%</div>
            <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_time_saved|floatformat:0 }}</div>
            <div class="stat-label">–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ (–º—Å)</div>
        </div>
    </div>
</div>

<!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="card">
    <h3>üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π</h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #ecf0f1;">ID</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #ecf0f1;">–°—Ç–∞—Ç—É—Å</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #ecf0f1;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ecf0f1;">–£–ª—É—á—à–µ–Ω–∏–µ</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ecf0f1;">–ê–Ω–∞–ª–∏—Ç–∏–∫</th>
                    <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #ecf0f1;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for query in queries %}
                <tr style="border-bottom: 1px solid #ecf0f1;">
                    <td style="padding: 0.75rem;">
                        <strong>#{{ query.id }}</strong>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span class="status-badge status-{{ query.status }}">
                            {{ query.get_status_display }}
                        </span>
                    </td>
                    <td style="padding: 0.75rem;">
                        {{ query.get_problem_category_display|default:"-" }}
                    </td>
                    <td style="padding: 0.75rem; text-align: right;">
                        {% if query.actual_improvement %}
                        <span style="color: #27ae60; font-weight: bold;">+{{ query.actual_improvement|floatformat:1 }}%</span>
                        {% else %}
                        <span style="color: #7f8c8d;">-</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem; text-align: right;">
                        {% if query.assigned_to %}
                            {{ query.assigned_to.get_full_name|default:query.assigned_to.username }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">
                        <a href="{% url 'query_detail' query.id %}" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                            üîç –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding: 2rem; text-align: center; color: #7f8c8d;">
                        üì≠ –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}