{% extends 'query_lab/base.html' %}
{% load humanize %}

{% block title %}–î–∞—à–±–æ—Ä–¥ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_queries }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ new_queries }}</div>
        <div class="stat-label">–ù–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ my_queries }}</div>
        <div class="stat-label">–ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ status_stats|length }}</div>
        <div class="stat-label">–°—Ç–∞—Ç—É—Å–æ–≤</div>
    </div>
</div>

<div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    <div class="card">
        <h2>üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
        {% for stat in status_stats %}
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
            <span class="status-badge status-{{ stat.get_status_display }}">
                {{ stat.get_status_display }}
            </span>
            <strong>{{ stat.count }}</strong>
        </div>
        {% empty %}
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞—Ç—É—Å–∞—Ö</p>
        {% endfor %}
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ø—Ä–æ–±–ª–µ–º -->
    <div class="card">
        <h2>üîç –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º</h2>
        {% for stat in category_stats %}
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
            <span>{{ stat.get_problem_category_display }}</span>
            <strong>{{ stat.count }}</strong>
        </div>
        {% empty %}
        <p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</p>
        {% endfor %}
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã -->
<div class="card">
    <h2>üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
    {% for query in recent_queries %}
    <div class="query-item {% if query.status == 'new' %}critical{% elif query.status == 'optimized' %}optimized{% endif %}">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
                <span class="status-badge status-{{ query.status }}">
                    {{ query.get_status_display }}
                </span>
                <strong>
                    <a href="{% url 'query_detail' query.id %}" style="color: #2c3e50; text-decoration: none;">
                        –ó–∞–ø—Ä–æ—Å #{{ query.id }}
                    </a>
                </strong>
                {% if query.problem_category %}
                <span style="margin-left: 1rem; color: #7f8c8d;">
                    {{ query.get_problem_category_display }}
                </span>
                {% endif %}
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.2rem; font-weight: bold; color: #e74c3c;">
                    {{ query.get_duration_seconds|floatformat:1 }}—Å
                </div>
                <div style="font-size: 0.8rem; color: #7f8c8d;">
                    {{ query.created_at|date:"d.m.Y H:i" }}
                </div>
            </div>
        </div>
        
        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">
            üë§ {{ query.query_log.user }} ‚Ä¢ 
            üìä {{ query.query_log.read_rows|default:0 }} —Å—Ç—Ä–æ–∫
        </div>
        
        <div class="sql-code" style="font-size: 0.8rem;">
{{ query.query_log.query_text|truncatewords:30 }}
        </div>
        
        {% if query.assigned_to %}
        <div style="font-size: 0.8rem; color: #3498db;">
            üéØ –ù–∞–∑–Ω–∞—á–µ–Ω: {{ query.assigned_to.get_full_name|default:query.assigned_to.username }}
        </div>
        {% else %}
        <div style="font-size: 0.8rem; color: #e74c3c;">
            ‚ö†Ô∏è –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
        </div>
        {% endif %}
    </div>
    {% empty %}
    <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
        üì≠ –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    </div>
    {% endfor %}
    
    <div style="text-align: center; margin-top: 1rem;">
        <a href="{% url 'query_list' %}" class="btn">
            üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
        </a>
    </div>
</div>
{% endblock %}