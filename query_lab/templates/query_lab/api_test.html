{% extends 'query_lab/base.html' %}

{% block title %}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∞–Ω–∞–ª–∏–∑–∞ - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
<div class="card">
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</h1>
    <p>–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∞–Ω–∞–ª–∏–∑ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ API</p>
</div>

<div class="card">
    <h3>üìù –í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>

    <form id="analyzeForm">
        {% csrf_token %}
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                SQL –∑–∞–ø—Ä–æ—Å:
            </label>
            <textarea id="queryInput"
                      style="width: 100%; padding: 1rem; border: 1px solid #bdc3c7; border-radius: 4px; font-family: monospace; min-height: 150px;"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...">SELECT * FROM users WHERE age != 30 AND name LIKE '%john%'</textarea>
        </div>

        <button type="submit" class="btn" style="background: #3498db;">
            üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å
        </button>
    </form>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
<div class="card" id="results" style="display: none;">
    <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
    <div id="analysisResults"></div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading" style="display: none; text-align: center; padding: 2rem;">
    <div style="font-size: 2rem;">‚è≥</div>
    <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å...</p>
</div>

<script>
document.getElementById('analyzeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const query = document.getElementById('queryInput').value.trim();
    if (!query) {
        alert('–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
        return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    fetch('{% url "analyze_query_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            query: query
        })
    })
    .then(response => response.json())
    .then(data => {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';

        if (data.success) {
            displayAnalysisResults(data);
        } else {
            document.getElementById('analysisResults').innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px;">
                    <strong>–û—à–∏–±–∫–∞:</strong> ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('analysisResults').innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px;">
                <strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:</strong> ${error}
            </div>
        `;
    });
});

function displayAnalysisResults(data) {
    const resultsDiv = document.getElementById('analysisResults');
    let html = '';

    // –°–≤–æ–¥–∫–∞
    html += `
        <div style="background: #2c3e50; color: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold;">${data.analysis.summary.total_patterns}</div>
                    <div style="font-size: 0.8rem;">–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">${data.analysis.summary.critical_count}</div>
                    <div style="font-size: 0.8rem;">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">${data.analysis.summary.high_count}</div>
                    <div style="font-size: 0.8rem;">–í—ã—Å–æ–∫–∏—Ö</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${data.analysis.summary.medium_count}</div>
                    <div style="font-size: 0.8rem;">–°—Ä–µ–¥–Ω–∏—Ö</div>
                </div>
            </div>
        </div>
    `;

    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
    if (data.analysis.detected_patterns.length > 0) {
        html += `<h4>üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4>`;

        data.analysis.detected_patterns.forEach(pattern => {
            const priorityColor =
                pattern.priority === 'critical' ? '#e74c3c' :
                pattern.priority === 'high' ? '#f39c12' : '#3498db';

            html += `
                <div style="border-left: 4px solid ${priorityColor}; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong>${pattern.name}</strong>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; background: ${priorityColor}; color: white;">
                            ${pattern.priority}
                        </span>
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem;">
            `;

            pattern.recommendations.forEach(rec => {
                html += `<li>${rec}</li>`;
            });

            html += `</ul></div>`;
        });

        // –®–∞–±–ª–æ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        html += `
            <h4>üöÄ –®–∞–±–ª–æ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:</h4>
            <div class="sql-code" style="background: #d4edda; color: #155724; margin-bottom: 1rem;">
                ${data.optimized_template}
            </div>
        `;
    } else {
        html += `
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h4>–ü—Ä–æ–±–ª–µ–º—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</h4>
                <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã—è–≤–∏–ª —è–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤ –∑–∞–ø—Ä–æ—Å–µ</p>
            </div>
        `;
    }

    // –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
    html += `<h4>üìö –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ ClickHouse:</h4>`;
    data.best_practices.forEach(category => {
        html += `
            <div style="margin-bottom: 1rem;">
                <strong>${category.category}:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
        `;
        category.items.forEach(item => {
            html += `<li>${item}</li>`;
        });
        html += `</ul></div>`;
    });

    resultsDiv.innerHTML = html;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É SQL
    document.querySelectorAll('.sql-code').forEach(block => {
        highlightSQL(block);
    });
}
</script>
{% endblock content %}