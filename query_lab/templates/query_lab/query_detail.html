{% extends 'query_lab/base.html' %}
{% load humanize %}

{% block title %}–ó–∞–ø—Ä–æ—Å #{{ sq.id }} - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
<div class="card">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫, —Å—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
        <div>
            <h1 style="margin: 0; color: #2c3e50;">
                –ó–∞–ø—Ä–æ—Å #{{ sq.id }}
            </h1>
            <div style="margin-top: 0.5rem;">
                <span class="status-badge status-{{ sq.status }}">
                    {{ sq.get_status_display }}
                </span>
                {% if sq.problem_category %}
                <span style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: #ecf0f1; border-radius: 12px; font-size: 0.8rem;">
                    {{ sq.get_problem_category_display }}
                </span>
                {% endif %}
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c; margin-bottom: 0.5rem;">
                {{ sq.get_duration_seconds|floatformat:1 }}—Å
            </div>
            <div style="color: #7f8c8d;">
                {{ sq.created_at|date:"d.m.Y H:i" }}
            </div>
            <!-- –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
            <a href="{% url 'query_lab:analyze_query' sq.id %}" class="btn" style="background: #3498db; color: white; padding: 0.3rem 0.8rem; margin-top: 0.5rem;">
                üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div>
            <h3>üìä –ú–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>
                    <strong>{{ query_log.user }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫:</span>
                    <strong>{{ query_log.read_rows|default:0 }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –±–∞–π—Ç:</span>
                    <strong>{{ query_log.read_bytes|filesizeformat }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü–∞–º—è—Ç—å:</span>
                    <strong>{{ query_log.memory_usage|filesizeformat }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>–ù–∞—á–∞–ª–æ:</span>
                    <strong>{{ query_log.query_start_time|date:"d.m.Y H:i:s" }}</strong>
                </div>
            </div>
        </div>

        <div>
            <h3>üë• –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h3>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                {% if sq.assigned_to %}
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë§</div>
                    <strong>{{ sq.assigned_to.get_full_name|default:sq.assigned_to.username }}</strong>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">
                        {{ sq.assigned_to.email }}
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; color: #e74c3c;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                    <strong>–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å -->
    <div class="sql-block" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="margin: 0;">üìù –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å</h3>
            <button type="button" class="btn" style="background: #9b59b6; padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                    onclick="copySQL(this)">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        <pre class="sql-code" style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ query_log.query_text }}</pre>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
    {% if query_analysis %}
    <div style="margin-bottom: 2rem;">
        <h3>üî¨ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>

        <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å -->
        <div style="background: #2c3e50; color: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold;">–°–ª–æ–∂–Ω–æ—Å—Ç—å: {{ query_analysis.complexity_score }}/100</div>
                </div>
                {% if query_analysis.has_full_scan %}
                <div style="background: #e74c3c; padding: 0.25rem 0.75rem; border-radius: 12px;">‚ö†Ô∏è Full scan</div>
                {% endif %}
                {% if query_analysis.has_sorting %}
                <div style="background: #f39c12; padding: 0.25rem 0.75rem; border-radius: 12px;">üîÑ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
                {% endif %}
                {% if query_analysis.has_aggregation %}
                <div style="background: #3498db; padding: 0.25rem 0.75rem; border-radius: 12px;">üßÆ –ê–≥—Ä–µ–≥–∞—Ü–∏—è</div>
                {% endif %}
            </div>
        </div>

        <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        {% if query_analysis.recommendations %}
        <div style="margin-bottom: 1rem;">
            <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
            <ul style="padding-left: 1.5rem;">
                {% for rec in query_analysis.recommendations %}
                <li>{{ rec }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
        {% if query_analysis.warnings %}
        <div style="margin-bottom: 1rem;">
            <h4>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h4>
            {% for w in query_analysis.warnings %}
            <div style="margin-left: 1.5rem; margin-bottom: 0.3rem;">‚Ä¢ {{ w.message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- EXPLAIN (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
        {% if query_analysis.explain_plan %}
        <details>
            <summary style="cursor: pointer; margin-bottom: 0.5rem; color: #3498db;">üìã –ü–æ–∫–∞–∑–∞—Ç—å EXPLAIN indexes = 1</summary>
            <pre style="background: #1a1a1a; color: #00ff00; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ query_analysis.explain_plan }}</pre>
        </details>
        {% endif %}
    </div>
    {% else %}
    <div style="background: #f8f9fa; padding: 2rem; text-align: center; border-radius: 4px; margin-bottom: 2rem;">
        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
        <p>–ê–Ω–∞–ª–∏–∑ –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑¬ª –≤—ã—à–µ.</p>
    </div>
    {% endif %}

    <!-- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
    {% if sq.optimized_query %}
    <div class="sql-block" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="margin: 0; color: #27ae60;">üöÄ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å</h3>
            <button type="button" class="btn" style="background: #27ae60; padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                    onclick="copySQL(this)">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        <pre class="sql-code" style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ sq.optimized_query }}</pre>

        {% if sq.optimization_notes %}
        <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 1rem; margin-top: 1rem;">
            <strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:</strong><br>
            {{ sq.optimization_notes|linebreaks }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
    {% if sq.actual_improvement %}
    <div style="margin-bottom: 2rem;">
        <h3>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
            <div style="background: #e74c3c; color: white; padding: 1rem; border-radius: 4px;">
                <div style="font-size: 0.9rem;">–î–æ</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ sq.before_duration_ms|floatformat:0 }} –º—Å</div>
            </div>
            <div style="background: #27ae60; color: white; padding: 1rem; border-radius: 4px;">
                <div style="font-size: 0.9rem;">–ü–æ—Å–ª–µ</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ sq.after_duration_ms|floatformat:0 }} –º—Å</div>
            </div>
            <div style="background: #3498db; color: white; padding: 1rem; border-radius: 4px;">
                <div style="font-size: 0.9rem;">–£–ª—É—á—à–µ–Ω–∏–µ</div>
                <div style="font-size: 1.5rem; font-weight: bold;">+{{ sq.actual_improvement }}%</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div style="display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #ecf0f1; padding-top: 1rem;">
        <a href="{% url 'query_lab:query_list' %}" class="btn">üìã –ö —Å–ø–∏—Å–∫—É</a>
        <a href="{% url 'admin:query_lab_slowquery_change' sq.id %}" class="btn btn-warning" target="_blank">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    </div>



</div>

<script>
function copySQL(button) {
    const sqlBlock = button.closest('.sql-block').querySelector('.sql-code');
    const text = sqlBlock.textContent || sqlBlock.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const original = button.innerHTML;
        button.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => button.innerHTML = original, 2000);
    });
}
</script>
{% endblock %}