{% extends 'query_lab/base.html' %}
{% load humanize %}

{% block title %}–ó–∞–ø—Ä–æ—Å #{{ sq.id }} - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
<div class="card">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="margin: 0; color: #2c3e50;">
                –ó–∞–ø—Ä–æ—Å #{{ sq.id }}
            </h1>
            <div style="margin-top: 0.5rem;">
                <span class="status-badge status-{{ sq.status }}">
                    {{ sq.get_status_display }}
                </span>
                {% if sq.problem_category %}
                <span style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: #ecf0f1; border-radius: 12px; font-size: 0.8rem;">
                    {{ sq.get_problem_category_display }}
                </span>
                {% endif %}
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">
                {{ sq.get_duration_seconds|floatformat:1 }}—Å
            </div>
            <div style="color: #7f8c8d;">
                {{ sq.created_at|date:"d.m.Y H:i" }}
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div>
            <h3>üìä –ú–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>
                    <strong>{{ query_log.user }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫:</span>
                    <strong>{{ query_log.read_rows|default:0 }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –±–∞–π—Ç:</span>
                    <strong>{{ query_log.read_bytes|filesizeformat }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–∞–º—è—Ç–∏:</span>
                    <strong>{{ query_log.memory_usage|filesizeformat }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                    <strong>{{ query_log.query_start_time|date:"d.m.Y H:i:s" }}</strong>
                </div>
            </div>
        </div>

        <div>
            <h3>üë• –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h3>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                {% if sq.assigned_to %}
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë§</div>
                    <strong>{{ sq.assigned_to.get_full_name|default:sq.assigned_to.username }}</strong>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">
                        {{ sq.assigned_to.email }}
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; color: #e74c3c;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                    <strong>–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –∫–Ω–æ–ø–∫–æ–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div style="margin-bottom: 2rem;" class="sql-block">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="margin: 0;">üìù –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å</h3>
            <button type="button" class="btn" style="background: #9b59b6; padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                    onclick="copySQL(this)">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        <div class="sql-code">
{{ query_log.query_text }}
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã -->
    <div style="margin-bottom: 2rem;">
        <h3>üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã</h3>
        {% if sq.analysis_notes %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
            {{ sq.analysis_notes|linebreaks }}
        </div>
        {% else %}
        <div style="background: #f8f9fa; border-radius: 4px; padding: 2rem; text-align: center; color: #7f8c8d;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
            <p>–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã –µ—â–µ –Ω–µ –ø—Ä–æ–≤–µ–¥–µ–Ω</p>
        </div>
        {% endif %}

        {% if sq.tags %}
        <div style="margin-top: 1rem;">
            <strong>–¢–µ–≥–∏:</strong>
            {% for tag in sq.tags.split %}
            <span style="display: inline-block; background: #3498db; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; margin: 0.25rem;">
                {{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>


        <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
        <div class="card">
            <h3>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞</h3>

            {% if query_analysis.detected_patterns %}
            <!-- –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã -->
            <div style="margin-bottom: 2rem;">
                <h4>üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4>
                {% for pattern in query_analysis.detected_patterns %}
                <div style="border-left: 4px solid
                    {% if pattern.priority == 'critical' %}#e74c3c
                    {% elif pattern.priority == 'high' %}#f39c12
                    {% else %}#3498db{% endif %};
                    padding: 1rem; margin-bottom: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                        <strong>{{ pattern.name }}</strong>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;
                            background: {% if pattern.priority == 'critical' %}#e74c3c
                            {% elif pattern.priority == 'high' %}#f39c12
                            {% else %}#3498db{% endif %};
                            color: white;">
                            {{ pattern.priority }}
                        </span>
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        {% for rec in pattern.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>

            <!-- –°–≤–æ–¥–∫–∞ -->
            <div style="background: #2c3e50; color: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold;">{{ query_analysis.summary.total_patterns }}</div>
                        <div style="font-size: 0.8rem;">–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">{{ query_analysis.summary.critical_count }}</div>
                        <div style="font-size: 0.8rem;">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">{{ query_analysis.summary.high_count }}</div>
                        <div style="font-size: 0.8rem;">–í—ã—Å–æ–∫–∏—Ö</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">{{ query_analysis.summary.medium_count }}</div>
                        <div style="font-size: 0.8rem;">–°—Ä–µ–¥–Ω–∏—Ö</div>
                    </div>
                </div>
            </div>

            <!-- –®–∞–±–ª–æ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ -->
            <div style="margin-bottom: 1rem;">
                <h4>üöÄ –®–∞–±–ª–æ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:</h4>
                <div class="sql-code" style="background: #d4edda; color: #155724;">
    {{ optimized_template }}
                </div>
                <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.5rem;">
                    ‚ö†Ô∏è –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h4>–ü—Ä–æ–±–ª–µ–º—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</h4>
                <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã—è–≤–∏–ª —è–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤ –∑–∞–ø—Ä–æ—Å–µ</p>
            </div>
            {% endif %}

    <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å EXPLAIN -->
    <div class="card">
        <h3>üî¨ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (EXPLAIN)</h3>

        {% if advanced_analysis.error %}
        <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px;">
            <strong>–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:</strong> {{ advanced_analysis.error }}
        </div>
        {% else %}

        <!-- –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
        {% if advanced_analysis.explain_analysis.plan_steps %}
        <div style="margin-bottom: 2rem;">
            <h4>üìã –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (EXPLAIN PLAN):</h4>
            <div style="background: #2c3e50; color: white; padding: 1rem; border-radius: 4px; font-family: monospace;">
                {% for step in advanced_analysis.explain_analysis.plan_steps %}
                <div style="margin-bottom: 0.5rem;">{{ step }}</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Pipeline -->
        {% if advanced_analysis.explain_analysis.pipeline_steps %}
        <div style="margin-bottom: 2rem;">
            <h4>‚öôÔ∏è Pipeline (EXPLAIN PIPELINE):</h4>
            <div style="background: #34495e; color: white; padding: 1rem; border-radius: 4px; font-family: monospace;">
                {% for step in advanced_analysis.explain_analysis.pipeline_steps %}
                <div style="margin-bottom: 0.5rem;">{{ step }}</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
        {% if advanced_analysis.warnings %}
        <div style="margin-bottom: 2rem;">
            <h4>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</h4>
            {% for warning in advanced_analysis.warnings %}
            <div style="border-left: 4px solid
                {% if warning.priority == 'high' %}#e74c3c
                {% elif warning.priority == 'medium' %}#f39c12
                {% else %}#3498db{% endif %};
                padding: 1rem; margin-bottom: 1rem; background: #f8f9fa; border-radius: 4px;">
                <strong>{{ warning.message }}</strong>
                <div style="font-size: 0.8rem; color: #7f8c8d;">
                    –¢–∏–ø: {{ warning.type }} | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ warning.priority }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü -->
        {% if advanced_analysis.table_analysis %}
        <div style="margin-bottom: 2rem;">
            <h4>üìä –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü:</h4>
            {% for table_name, stats in advanced_analysis.table_analysis.items %}
            {% if stats and 'error' not in stats %}
            <div style="border: 1px solid #ecf0f1; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                <strong>{{ table_name }}</strong>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                    <div>
                        <small>–î–≤–∏–∂–æ–∫:</small><br>
                        <strong>{{ stats.engine }}</strong>
                    </div>
                    <div>
                        <small>–°—Ç—Ä–æ–∫:</small><br>
                        <strong>{{ stats.total_rows|intcomma }}</strong>
                    </div>
                    <div>
                        <small>–†–∞–∑–º–µ—Ä:</small><br>
                        <strong>{{ stats.size_gb|floatformat:2 }} GB</strong>
                    </div>
                    <div>
                        <small>–ü–∞—Ä—Ç–∏—Ü–∏–∏:</small><br>
                        <strong>{{ stats.partition_key|default:"–Ω–µ—Ç" }}</strong>
                    </div>
                    <div>
                        <small>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</small><br>
                        <strong>{{ stats.sorting_key|default:"–Ω–µ—Ç" }}</strong>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {% endif %}
    </div>

            <!-- –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
            <div>
                <h4>üìö –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:</h4>
                {% for category in best_practices %}
                <div style="margin-bottom: 1rem;">
                    <strong>{{ category.category }}:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                        {% for item in category.items %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
        </div>

    <!-- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –∫–Ω–æ–ø–∫–æ–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
    {% if sq.optimized_query %}
    <div style="margin-bottom: 2rem;" class="sql-block">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="margin: 0;">üöÄ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å</h3>
            <button type="button" class="btn" style="background: #27ae60; padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                    onclick="copySQL(this)">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        <div class="sql-code" style="background: #d4edda; color: #155724;">
{{ sq.optimized_query }}
        </div>
    </div>
    {% endif %}
        
        {% if sq.optimization_notes %}
        <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 1rem; margin-top: 1rem;">
            <strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:</strong><br>
            {{ sq.optimization_notes|linebreaks }}
        </div>
        {% endif %}

        {% if sq.expected_improvement %}
        <div style="margin-top: 1rem;">
            <strong>–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:</strong> 
            <span style="color: #27ae60; font-weight: bold;">
                +{{ sq.expected_improvement }}%
            </span>
        </div>
        {% endif %}
    </div>


    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
    {% if sq.actual_improvement %}
    <div style="margin-bottom: 2rem;">
        <h3>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
            <div style="background: #e74c3c; color: white; padding: 1rem; border-radius: 4px;">
                <div style="font-size: 0.9rem;">–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ sq.before_duration_ms|floatformat:0 }}–º—Å</div>
            </div>
            <div style="background: #27ae60; color: white; padding: 1rem; border-radius: 4px;">
                <div style="font-size: 0.9rem;">–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ sq.after_duration_ms|floatformat:0 }}–º—Å</div>
            </div>
            <div style="background: #3498db; color: white; padding: 1rem; border-radius: 4px;">
                <div style="font-size: 0.9rem;">–£–ª—É—á—à–µ–Ω–∏–µ</div>
                <div style="font-size: 1.5rem; font-weight: bold;">+{{ sq.actual_improvement }}%</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div style="display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #ecf0f1; padding-top: 1rem;">
        <a href="{% url 'query_list' %}" class="btn">
            üìã –ö —Å–ø–∏—Å–∫—É
        </a>
        <a href="{% url 'admin:query_lab_slowquery_change' sq.id %}" class="btn btn-warning" target="_blank">
            ‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </a>
    </div>

    <!-- –§–æ—Ä–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã -->
    <div style="margin-bottom: 2rem;">
        <h3>üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã</h3>

        {% if sq.analysis_notes %}
        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑ -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
            {{ sq.analysis_notes|linebreaks }}
        </div>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ -->
        <form method="post" style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px;">
            {% csrf_token %}
            <input type="hidden" name="analyze" value="1">

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–±–ª–µ–º—ã:
                </label>
                {{ analysis_form.problem_category }}
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    –ó–∞–º–µ—Ç–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:
                </label>
                {{ analysis_form.analysis_notes }}
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    –¢–µ–≥–∏:
                </label>
                {{ analysis_form.tags }}
                <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.25rem;">
                    –ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: –º–µ–¥–ª–µ–Ω–Ω—ã–π_join, –ø–æ–ª–Ω–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–æ–ª—å—à–æ–π_—Ä–µ–∑—É–ª—å—Ç–∞—Ç
                </div>
            </div>

            <button type="submit" class="btn btn-warning">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
    <div style="margin-bottom: 2rem;">
        <h3>üöÄ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é</h3>

        {% if sq.optimized_query %}
        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å –∫–Ω–æ–ø–∫–æ–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="sql-block">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                <h4 style="margin: 0; color: #27ae60;">–¢–µ–∫—É—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:</h4>
                <button type="button" class="btn" style="background: #27ae60; padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                        onclick="copySQL(this)">
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            <div class="sql-code" style="background: #d4edda; color: #155724; margin-bottom: 1rem;">
{{ sq.optimized_query }}
            </div>
        </div>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
        <form method="post" style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px;">
            {% csrf_token %}
            <input type="hidden" name="optimize" value="1">

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <label style="font-weight: bold;">
                        –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
                    </label>
                    <button type="button" class="btn" style="background: #3498db; padding: 0.25rem 0.75rem; font-size: 0.8rem;"
                            onclick="copyToClipboard(document.querySelector('#id_optimized_query').value)">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
                {{ optimization_form.optimized_query }}
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:
                </label>
                {{ optimization_form.expected_improvement }} %
            </div>

            <button type="submit" class="btn btn-success">
                üöÄ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
            </button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    {% if sq.optimized_query and not sq.actual_improvement %}
    <div style="margin-bottom: 2rem;">
        <h3>üìà –ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>

        <form method="post" style="background: #f8f9fa; padding: 1.5rem; border-radius: 4px;">
            {% csrf_token %}
            <input type="hidden" name="save_results" value="1">

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ:
                    </label>
                    {{ results_form.before_duration_ms }}
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ:
                    </label>
                    {{ results_form.after_duration_ms }}
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        –£–ª—É—á—à–µ–Ω–∏–µ:
                    </label>
                    {{ results_form.actual_improvement }} %
                </div>
            </div>

            <button type="submit" class="btn">
                üìä –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </button>
        </form>
    </div>
    {% endif %}

    <!-- –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">

            <!-- –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–µ–±–µ -->
            {% if not sq.assigned_to or sq.assigned_to != request.user %}
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="quick_action" value="assign_to_me">
                <button type="submit" class="btn" style="background: #3498db;">
                    üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –º–Ω–µ
                </button>
            </form>
            {% endif %}

            <!-- –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑ -->
            {% if sq.status == 'new' %}
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="quick_action" value="start_analysis">
                <button type="submit" class="btn" style="background: #f39c12;">
                    üîç –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑
                </button>
            </form>
            {% endif %}

            <!-- –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π -->
            {% if sq.status == 'waiting_feedback' %}
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="quick_action" value="mark_optimized">
                <button type="submit" class="btn" style="background: #27ae60;">
                    ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω
                </button>
            </form>
            {% endif %}

            <!-- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å -->
            {% if sq.status in 'new,in_analysis' %}
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="quick_action" value="mark_ignored">
                <button type="submit" class="btn" style="background: #95a5a6;">
                    ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </form>
            {% endif %}

            <!-- –ù–µ –ø–æ–¥–ª–µ–∂–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
            {% if sq.status in 'new,in_analysis' %}
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="quick_action" value="cannot_optimize">
                <button type="submit" class="btn" style="background: #e74c3c;">
                    üö´ –ù–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç—Å—è
                </button>
            </form>
            {% endif %}

            <!-- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å -->
            <button type="button" class="btn" style="background: #9b59b6;"
                    onclick="copyToClipboard('{{ query_log.query_text|escapejs }}')">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å
            </button>

        </div>
    </div>


    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞</h3>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="flex-grow: 1; background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; background: linear-gradient(90deg, #3498db, #27ae60); width:
                    {% if sq.status == 'new' %}10%
                    {% elif sq.status == 'in_analysis' %}40%
                    {% elif sq.status == 'waiting_feedback' %}70%
                    {% elif sq.status == 'optimized' %}100%
                    {% else %}0%{% endif %};
                    transition: width 0.3s ease;">
                </div>
            </div>
            <div style="font-weight: bold; color: #2c3e50;">
                {% if sq.status == 'new' %}–û–±–Ω–∞—Ä—É–∂–µ–Ω
                {% elif sq.status == 'in_analysis' %}–í –∞–Ω–∞–ª–∏–∑–µ
                {% elif sq.status == 'waiting_feedback' %}–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
                {% elif sq.status == 'optimized' %}–ó–∞–≤–µ—Ä—à–µ–Ω
                {% else %}–ó–∞–≤–µ—Ä—à–µ–Ω{% endif %}
            </div>
        </div>

        <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
            <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: #7f8c8d;">–û–±–Ω–∞—Ä—É–∂–µ–Ω</div>
                <div style="font-size: 0.7rem; color: #bdc3c7;">{{ sq.created_at|date:"d.m" }}</div>
            </div>

            <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: {% if sq.status != 'new' %}#2c3e50{% else %}#7f8c8d{% endif %};">
                    –ê–Ω–∞–ª–∏–∑
                </div>
                <div style="font-size: 0.7rem; color: #bdc3c7;">
                    {% if sq.analysis_started_at %}{{ sq.analysis_started_at|date:"d.m" }}{% endif %}
                </div>
            </div>

            <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: {% if sq.status == 'waiting_feedback' or sq.status == 'optimized' %}#2c3e50{% else %}#7f8c8d{% endif %};">
                    –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
                </div>
                <div style="font-size: 0.7rem; color: #bdc3c7;">
                    {% if sq.optimized_query %}‚úÖ{% endif %}
                </div>
            </div>

            <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: {% if sq.status == 'optimized' %}#2c3e50{% else %}#7f8c8d{% endif %};">
                    –ó–∞–≤–µ—Ä—à–µ–Ω
                </div>
                <div style="font-size: 0.7rem; color: #bdc3c7;">
                    {% if sq.optimized_at %}{{ sq.optimized_at|date:"d.m" }}{% endif %}
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}