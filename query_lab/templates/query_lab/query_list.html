{% extends 'query_lab/base.html' %}
{% load humanize %}
{% block title %}–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}
<div class="card">
    <h2>üìã –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏</h2>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-bar">
        <select class="filter-select" onchange="window.location.href = this.value">
            <option value="?">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            {% for status, label in status_choices %}
            <option value="?status={{ status }}" {% if status_filter == status %}selected{% endif %}>
                {{ label }}
            </option>
            {% endfor %}
        </select>
        
        <select class="filter-select" onchange="window.location.href = this.value">
            <option value="?">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            {% for category, label in category_choices %}
            <option value="?category={{ category }}" {% if category_filter == category %}selected{% endif %}>
                {{ label }}
            </option>
            {% endfor %}
        </select>
        
        <select class="filter-select" onchange="window.location.href = this.value">
            <option value="?">–í—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</option>
            <option value="?assigned=me" {% if assigned_filter == 'me' %}selected{% endif %}>–ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã</option>
            <option value="?assigned=unassigned" {% if assigned_filter == 'unassigned' %}selected{% endif %}>–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</option>
        </select>
        
        <div style="flex-grow: 1;"></div>
        <span style="color: #7f8c8d;">
            –ù–∞–π–¥–µ–Ω–æ: {{ queries.count }} –∑–∞–ø—Ä–æ—Å–æ–≤
        </span>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    {% for query in queries %}
    <div class="query-item {% if query.status == 'new' %}critical{% elif query.status == 'optimized' %}optimized{% endif %}">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
                <span class="status-badge status-{{ query.status }}">
                    {{ query.get_status_display }}
                </span>
                <strong>
                    <a href="{% url 'query_lab:query_detail' query.id %}" style="color: #2c3e50; text-decoration: none;">
                        –ó–∞–ø—Ä–æ—Å #{{ query.id }}
                    </a>
                </strong>
                {% if query.problem_category %}
                <span style="margin-left: 1rem; color: #7f8c8d;">
                    {{ query.get_problem_category_display }}
                </span>
                {% endif %}
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.2rem; font-weight: bold; color: #e74c3c;">
                    {{ query.get_duration_seconds|floatformat:1 }}—Å
                </div>
                <div style="font-size: 0.8rem; color: #7f8c8d;">
                    {{ query.created_at|date:"d.m.Y H:i" }}
                </div>
            </div>
        </div>
        
        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">
            üë§ {{ query.query_log.user }} ‚Ä¢ 
            üìä {{ query.query_log.read_rows|default:0 }} —Å—Ç—Ä–æ–∫
            üíæ {{ query.query_log.read_bytes|filesizeformat }}
        </div>
        
        <div class="sql-code" style="font-size: 0.8rem;">
{{ query.query_log.query_text|truncatewords:50 }}
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
            <div>
                {% if query.assigned_to %}
                <span style="font-size: 0.8rem; color: #3498db;">
                    üéØ {{ query.assigned_to.get_full_name|default:query.assigned_to.username }}
                </span>
                {% else %}
                <span style="font-size: 0.8rem; color: #e74c3c;">
                    ‚ö†Ô∏è –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                </span>
                {% endif %}
            </div>
            <div>
                <a href="{% url 'query_lab:query_detail' query.id %}" class="btn">
                    üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                </a>
            </div>
        </div>
    </div>
    {% empty %}
    <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
        <h3>–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
        <p>–ó–∞–ø—Ä–æ—Å—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º, –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
    </div>
    {% endfor %}
</div>
{% endblock %}