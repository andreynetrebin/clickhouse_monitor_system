{% extends 'query_lab/base.html' %}
{% load humanize %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤{% endblock %}

{% block content %}
<div class="card">
    <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏</h1>
    <p style="color: #7f8c8d; margin-bottom: 2rem;">
        –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞: {{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }}
    </p>
</div>

<!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_queries }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ optimized_queries }}</div>
        <div class="stat-label">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ optimization_rate|floatformat:1 }}%</div>
        <div class="stat-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ avg_improvement|floatformat:1 }}%</div>
        <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div>
        <!-- –¢–æ–ø —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π -->
        <div class="card">
            <h3>üöÄ –¢–æ–ø —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π</h3>
            {% for query in top_optimizations %}
            <div style="border-left: 4px solid #27ae60; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa; border-radius: 4px;">
                <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                    <div>
                        <strong>
                            <a href="{% url 'query_detail' query.id %}" style="color: #2c3e50;">
                                –ó–∞–ø—Ä–æ—Å #{{ query.id }}
                            </a>
                        </strong>
                        <span style="margin-left: 1rem; color: #7f8c8d;">
                            {{ query.get_problem_category_display }}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">
                            +{{ query.actual_improvement|floatformat:1 }}%
                        </div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">
                            {{ query.optimized_at|date:"d.m.Y" }}
                        </div>
                    </div>
                </div>
                <div class="sql-code" style="font-size: 0.7rem; margin: 0;">
{{ query.query_log.query_text|truncatewords:20 }}
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ö
            </div>
            {% endfor %}
        </div>

        <!-- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞–º -->
        <div class="card">
            <h3>üë• –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤</h3>
            {% for analyst in analyst_performance %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #ecf0f1;">
                <div>
                    <strong>{{ analyst.assigned_to__first_name }} {{ analyst.assigned_to__last_name|default:analyst.assigned_to__username }}</strong>
                    <div style="font-size: 0.8rem; color: #7f8c8d;">
                        {{ analyst.optimized }}/{{ analyst.total }} –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold; color: #27ae60;">
                        {% if analyst.avg_improvement %}
                        +{{ analyst.avg_improvement|floatformat:1 }}%
                        {% else %}
                        -
                        {% endif %}
                    </div>
                    <div style="font-size: 0.8rem; color: #7f8c8d;">
                        {{ analyst.optimized|floatformat:0 }}%
                    </div>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                üë• –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞–º
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div>
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º -->
        <div class="card">
            <h3>üîç –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
            {% for category in problem_categories %}
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span>{{ category.get_problem_category_display }}</span>
                    <strong>{{ category.count }}</strong>
                </div>
                <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; background: #3498db; width: {{ category.count|divisibleby:total_queries|floatformat:0 }}%;"></div>
                </div>
                {% if category.avg_improvement %}
                <div style="font-size: 0.8rem; color: #7f8c8d; text-align: right;">
                    +{{ category.avg_improvement|floatformat:1 }}% —É–ª—É—á—à–µ–Ω–∏–µ
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div style="text-align: center; padding: 1rem; color: #7f8c8d;">
                üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            </div>
            {% endfor %}
        </div>

        <!-- –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ -->
        <div class="card">
            <h3>‚è±Ô∏è –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏</h3>
            {% if analysis_time_stats.avg_analysis_days %}
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; font-weight: bold; color: #3498db;">
                    {{ analysis_time_stats.avg_analysis_days|floatformat:1 }}
                </div>
                <div style="color: #7f8c8d;">—Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ (–¥–Ω–∏)</div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                ‚è∞ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∞
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã -->
<div class="card">
    <h3>üìà –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã</h3>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #ecf0f1;">–î–∞—Ç–∞</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ecf0f1;">–í—Å–µ–≥–æ</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ecf0f1;">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ecf0f1;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #ecf0f1;">–£–ª—É—á—à–µ–Ω–∏–µ</th>
                </tr>
            </thead>
            <tbody>
                {% for day in daily_trends %}
                <tr style="border-bottom: 1px solid #ecf0f1;">
                    <td style="padding: 0.75rem;">{{ day.day|date:"d.m.Y" }}</td>
                    <td style="padding: 0.75rem; text-align: right;">{{ day.total }}</td>
                    <td style="padding: 0.75rem; text-align: right;">{{ day.optimized }}</td>
                    <td style="padding: 0.75rem; text-align: right;">
                        {% if day.total %}
                        {{ day.optimized|divisibleby:day.total|floatformat:1 }}%
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem; text-align: right;">
                        {% if day.improvement %}
                        +{{ day.improvement|floatformat:1 }}%
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 2rem; text-align: center; color: #7f8c8d;">
                        üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}